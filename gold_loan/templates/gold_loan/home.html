{% extends "gold_loan/base.html" %}
{% load static %}

{% block title %}Gold Loan | Punnagai{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'gold_loan/css/home.css' %}?v=3.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
<div class="landing-wrapper">
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-overlay"></div>

        <div class="container hero-content-grid">
            <!-- Left Side: Text & Actions -->
            <div class="hero-text">
                <span class="hero-badge">Trusted & Secure</span>
                <h1 class="animate-fadeInUp">PUNNAGAI <br>Gold Loan</h1>
                <p class="animate-fadeInUp delay-1">
                    Experience the standard of trust, transparency, and accuracy.
                    Manage gold loans with precision, from valuation to closure.
                </p>

                <div class="hero-actions animate-fadeInUp delay-2">
                    <a href="{% url 'gold_loan:loan_entry' %}" class="btn btn-primary btn-lg btn-glow">
                        Create New Loan
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </a>
                    <a href="{% url 'gold_loan:dashboard' %}" class="btn btn-secondary btn-lg">
                        View Dashboard
                    </a>
                </div>

                <div class="hero-stats animate-fadeInUp delay-3">
                    <div class="stat-item">
                        <span class="stat-val">100%</span>
                        <span class="stat-label">Secure</span>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <span class="stat-val">0%</span>
                        <span class="stat-label">Hidden Charges</span>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <span class="stat-val">24/7</span>
                        <span class="stat-label">Data Access</span>
                    </div>
                </div>
            </div>

            <!-- Right Side: Visual Calculator Card -->
            <div class="hero-visual animate-slideInRight">
                <div class="glass-card trust-dashboard">
                    <div class="gc-header">
                        <div class="gc-status">
                            <span class="status-pulse"></span>
                            Live Approvals
                        </div>
                        <div class="gc-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="gc-body dashboard-content">
                        <div class="metric-row">
                            <div class="metric-info">
                                <h3>Approval Speed</h3>
                                <p>Average processing time today</p>
                            </div>
                            <div class="metric-value">6.5 <small>min</small></div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-label">
                                <span>Verification Progress</span>
                                <span>94%</span>
                            </div>
                            <div class="progress-bar-wrap">
                                <div class="progress-fill" style="width: 94%"></div>
                            </div>
                        </div>

                        <div class="feature-grid-small">
                            <div class="f-pill">
                                <span class="f-icon">üõ°</span>
                                <span>Bank Grade</span>
                            </div>
                            <div class="f-pill">
                                <span class="f-icon">‚ö°</span>
                                <span>Instant</span>
                            </div>
                        </div>

                        <div class="activity-mini">
                            <div class="activity-item">
                                <div class="avatar-sm" style="background: #eff6ff;">S</div>
                                <div class="activity-text">
                                    <strong>‚Çπ 2.5L Loan</strong> Approved for Suresh M.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="gc-decoration">
                        <svg viewBox="0 0 400 100" preserveAspectRatio="none">
                            <path d="M0,80 C150,20 250,120 400,40 V100 H0 Z" fill="rgba(37, 99, 235, 0.05)"></path>
                            <path d="M0,80 C150,20 250,120 400,40" fill="none" stroke="rgba(37, 99, 235, 0.2)"
                                stroke-width="2"></path>
                        </svg>
                    </div>
                </div>

                <!-- Floating Elements for depth -->
                <div class="float-card fc-1 animate-float">
                    <div class="fc-icon success">‚úì</div>
                    <div class="fc-text">
                        <span>Instant Gold Loan Eligibility</span>
                        <small>Punnagai Certified</small>
                    </div>
                </div>

                <div class="float-card fc-2 animate-float">
                    <div class="fc-icon success" style="background: #eff6ff; color: var(--primary);">‚úì</div>
                    <div class="fc-text">
                        <span>Trusted by 50,000+</span>
                        <small>Active Customers</small>
                    </div>
                </div>

                <div class="float-card fc-3 animate-float">
                    <div class="fc-icon success" style="background: #fff7ed; color: #f59e0b;">üõ°</div>
                    <div class="fc-text">
                        <span>Safe Bank Vaults</span>
                        <small>100% Insured</small>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION 2: ABOUT / TRUST -->
    <section class="section about-section" id="about">
        <div class="container about-single">
            <div class="about-content animate-on-scroll">
                <div class="center-text">
                    <span class="section-badge">Why Choose Us</span>
                    <h2>Why Choose <span class="highlight">Punnagai Gold Loan?</span></h2>
                    <p class="section-desc">
                        We ensure your gold is valued transparently and securely. Experience the fastest approval
                        process
                        with zero hidden charges.
                    </p>
                </div>
                <ul class="feature-list grid-features">
                    <li>
                        <div class="icon-box">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="text">
                            <strong>Transparent Valuation</strong>
                            <span>Live market rates applied instantly.</span>
                        </div>
                    </li>
                    <li>
                        <div class="icon-box">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        <div class="text">
                            <strong>Secure Gold Handling</strong>
                            <span>Bank-grade security vaults for safety.</span>
                        </div>
                    </li>
                    <li>
                        <div class="icon-box">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="text">
                            <strong>Fast Approvals</strong>
                            <span>Get cash in hand within minutes.</span>
                        </div>
                    </li>
                    <li>
                        <div class="icon-box">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="text">
                            <strong>Accurate Interest Tracking</strong>
                            <span>Pay only for the days you use.</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </section>

    <!-- SECTION 3: ANALYTICS SNAPSHOT -->
    <section class="section analytics-section" id="analytics">
        <div class="container">
            <div class="section-header center animate-on-scroll">
                <span class="section-badge">Live Insights</span>
                <h2>Operations Overview</h2>
                <p>Real-time snapshot of loan performance and trends.</p>
            </div>

            <div class="analytics-grid animate-on-scroll delay-1">
                <!-- Loan Status Distribution -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Loan Status Distribution</h3>
                        <p>Current breakdown of all loans</p>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Daily Loan Creation Trend -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Daily Loan Creation Trend</h3>
                        <p>New loans over the last 30 days</p>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="leaderboard-grid animate-on-scroll delay-2" style="margin-top: 60px;">
                <!-- Top Customers -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Top 10 Customers</h3>
                        <p>By total number of loans</p>
                    </div>
                    <div class="card-body scrollable-card-body">
                        <ul class="leader-list">
                            {% for customer in top_customers %}
                            <li class="leader-item">
                                <a href="{% url 'gold_loan:customer_detail' customer.id %}" class="leader-link">
                                    <div class="leader-info">
                                        <div class="avatar-circle">
                                            {% if customer.photo %}
                                            <img src="{{ customer.photo.url }}" alt="{{ customer.name }}"
                                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                            {% else %}
                                            {{ customer.name|slice:":1" }}
                                            {% endif %}
                                        </div>
                                        <div class="leader-details">
                                            <span class="leader-name">{{ customer.name }}</span>
                                            <span class="leader-sub">ID: {{ customer.customer_id }}</span>
                                        </div>
                                    </div>
                                    <div class="leader-metric">
                                        <span class="metric-val">{{ customer.loan_count }}</span>
                                        <span class="metric-label">Loans</span>
                                    </div>
                                </a>
                            </li>
                            {% empty %}
                            <li class="leader-empty">No customers found</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Highest Active Loans -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Highest Active Loans</h3>
                        <p>Top 10 by loan amount</p>
                    </div>
                    <div class="card-body scrollable-card-body">
                        <ul class="leader-list">
                            {% for loan in top_active_loans %}
                            <li class="leader-item">
                                <a href="{% url 'gold_loan:loan_view' loan.id %}" class="leader-link">
                                    <div class="leader-info">
                                        <div class="avatar-circle gold">‚Çπ</div>
                                        <div class="leader-details">
                                            <span class="leader-name">{{ loan.loan_number }}</span>
                                            <span class="leader-sub">{{ loan.customer.name }}</span>
                                        </div>
                                    </div>
                                    <div class="leader-metric">
                                        <span class="metric-val">‚Çπ{{ loan.total_amount|floatformat:0 }}</span>
                                        <span class="metric-label">Principal</span>
                                    </div>
                                </a>
                            </li>
                            {% empty %}
                            <li class="leader-empty">No active loans found</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <a href="{% url 'gold_loan:analytics_dashboard' %}" class="btn btn-secondary btn-lg">
                    View Full Analytics Report
                </a>
            </div>
        </div>
    </section>

    {{ status_chart_data|json_script:"status-data" }}
    {{ daily_chart_data|json_script:"daily-data" }}

    <!-- SECTION 4: TRUST METRICS / STATS -->
    <section class="section stats-section">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card animate-on-scroll">
                    <div class="stat-number" data-target="100">0</div>
                    <div class="stat-label">Secure</div>
                    <div class="stat-sub">% Safety Guarantee</div>
                </div>
                <div class="stat-card animate-on-scroll delay-1">
                    <div class="stat-number" data-target="0">0</div>
                    <div class="stat-label">Hidden Charges</div>
                    <div class="stat-sub">Transparent Process</div>
                </div>
                <div class="stat-card animate-on-scroll delay-2">
                    <div class="stat-number" data-target="24">0</div>
                    <div class="stat-label">Data Access</div>
                    <div class="stat-sub">/7 Availability</div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION 5: FOOTER (Enhanced Punnagai Style) -->
    <footer class="app-footer">
        <div class="container">
            <div class="footer-top">
                <div class="footer-col">
                    <h4 class="accordion-header">Quick Access <span class="chevron">‚Ä∫</span></h4>
                    <ul class="footer-links">
                        <li><a href="{% url 'gold_loan:dashboard' %}">Dashboard</a></li>
                        <li><a href="{% url 'gold_loan:loan_entry' %}">New Loan Entry</a></li>
                        <li><a href="{% url 'gold_loan:analytics_dashboard' %}">Analytics & Reports</a></li>
                        <li><a href="{% url 'gold_loan:customer_list' %}">Customer Directory</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 class="accordion-header">Our Services <span class="chevron">‚Ä∫</span></h4>
                    <ul class="footer-links">
                        <li><a href="#about">Gold Valuation</a></li>
                        <li><a href="{% url 'gold_loan:extended_loans_list' %}">Loan Extensions</a></li>
                        <li><a href="{% url 'gold_loan:closed_loans_list' %}">Loan Closures</a></li>
                        <li><a href="#analytics">Interest Tracking</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 class="accordion-header">Company <span class="chevron">‚Ä∫</span></h4>
                    <ul class="footer-links">
                        <li><a href="#about">About Punnagai</a></li>
                        <li><a href="#">Fair Practice Code</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Use</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 class="accordion-header">Support <span class="chevron">‚Ä∫</span></h4>
                    <ul class="footer-links">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">FAQs</a></li>
                        <li><a href="#">Security Features</a></li>
                        <li><a href="#">Download Mobile App</a></li>
                    </ul>
                </div>
                <div class="footer-col contact-col">
                    <h4>Reach Us</h4>
                    <div class="contact-info">
                        <div class="contact-item">
                            <span class="icon">üìû</span>
                            <div class="details">
                                <small>Call Support</small>
                                <strong>+91 90000 00000</strong>
                            </div>
                        </div>
                        <div class="contact-item">
                            <span class="icon">üìß</span>
                            <div class="details">
                                <small>Email Us</small>
                                <strong>support@punnagai.in</strong>
                            </div>
                        </div>
                        <div class="contact-item">
                            <span class="icon">üìç</span>
                            <div class="details">
                                <small>Visit Office</small>
                                <strong>Main Road, Tamil Nadu</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-bottom-left">
                    <p>&copy; 2025 Punnagai Gold Loan Management System. All Rights Reserved.</p>
                </div>
                <div class="footer-bottom-right">
                    <div class="social-icons">
                        <a href="#" class="soc-icon" title="LinkedIn">in</a>
                        <a href="#" class="soc-icon" title="Twitter">tw</a>
                        <a href="#" class="soc-icon" title="Facebook">fb</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Header Scroll Effect ---
        const header = document.querySelector('.app-header');
        window.addEventListener('scroll', function () {
            if (header) {
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            }
        });

        // --- Scroll Animations (Intersection Observer) ---
        const observerOptions = {
            threshold: 0.1,
            rootMargin: "0px 0px -50px 0px"
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');

                    // Trigger counter animation if it's a stat card
                    if (entry.target.classList.contains('stat-card')) {
                        const numEl = entry.target.querySelector('.stat-number');
                        if (numEl && !numEl.classList.contains('counted')) {
                            animateValue(numEl, 0, parseInt(numEl.dataset.target), 2000);
                            numEl.classList.add('counted');
                        }
                    }
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        document.querySelectorAll('.animate-on-scroll').forEach(el => {
            observer.observe(el);
        });
        document.querySelectorAll('.stat-card').forEach(el => {
            observer.observe(el);
        });


        // --- Analytics Charts Initialization ---
        const statusDataEl = document.getElementById('status-data');
        const dailyDataEl = document.getElementById('daily-data');

        if (statusDataEl && dailyDataEl) {
            const statusData = JSON.parse(statusDataEl.textContent);
            const dailyData = JSON.parse(dailyDataEl.textContent);

            // 1. Loan Status Chart (Doughnut)
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusData.labels,
                    datasets: [{
                        data: statusData.data,
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { family: "'Outfit', sans-serif", size: 12 }
                            }
                        }
                    },
                    layout: { padding: 20 },
                    cutout: '75%'
                }
            });

            // 2. Daily Trends Chart (Line)
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyData.labels,
                    datasets: [{
                        label: 'New Loans',
                        data: dailyData.data,
                        borderColor: '#2563eb',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(37, 99, 235, 0.2)');
                            gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleFont: { family: "'Outfit', sans-serif" },
                            bodyFont: { family: "'Outfit', sans-serif" },
                            padding: 10,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [4, 4], color: '#f1f5f9' },
                            ticks: { font: { family: "'Outfit', sans-serif", size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: "'Outfit', sans-serif", size: 10 }, maxTicksLimit: 10 }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // --- Counter Animation ---
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // Handle 0% and 100% and 24/7 specific formatting if needed
                let val = Math.floor(progress * (end - start) + start);

                // Specific fix for "0% Hidden Charges" -> we want to show 0
                // Specific fix for "100%" -> we want to show 100

                let suffix = "";
                if (obj.nextElementSibling && obj.nextElementSibling.innerText.includes("%")) {
                    // suffix handled in HTML structure? No, suffix is separate div
                }

                // If end is 0, we just want 0.

                obj.innerHTML = val;

                // Hacky fix for formatting:
                if (end === 100) obj.innerHTML = val + "%";
                if (end === 0) obj.innerHTML = val + "%";
                if (end === 24) obj.innerHTML = val + "/7";

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    // Final Ensure
                    if (end === 100) obj.innerHTML = "100%";
                    if (end === 0) obj.innerHTML = "0%";
                    if (end === 24) obj.innerHTML = "24/7";
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- Footer Accordion (Mobile) ---
        const accordions = document.querySelectorAll('.accordion-header');
        accordions.forEach(acc => {
            acc.addEventListener('click', function () {
                if (window.innerWidth <= 768) {
                    this.parentElement.classList.toggle('active');
                    const links = this.nextElementSibling;
                    if (this.parentElement.classList.contains('active')) {
                        links.style.display = "block";
                    } else {
                        links.style.display = "none";
                    }
                }
            });
        });

        // Reset footer links on resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                document.querySelectorAll('.footer-links').forEach(el => el.style.display = 'block');
            } else {
                document.querySelectorAll('.footer-col').forEach(col => {
                    col.classList.remove('active');
                    if (col.querySelector('.footer-links')) col.querySelector('.footer-links').style.display = 'none';
                });
            }
        });
        // Initial check
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.footer-links').forEach(el => el.style.display = 'none');
        }

    });
</script>
{% endblock %}