{% extends "gold_loan/base.html" %}
{% load static %}

{% block title %}Loan Entry – Step 3{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'gold_loan/css/loan_entry.css' %}">
{% endblock %}

{% block page_header %}
<h3>Loan Entry – Step 3: Loan Details</h3>
{% endblock %}

{% block content %}
<form method="post" class="loan-form">
    {% csrf_token %}

    {% if error %}
    <div class="alert alert-error"
        style="margin-bottom: 20px; background: #fee2e2; color: #b91c1c; padding: 12px; border-radius: 8px; border: 1px solid #fecaca;">
        {{ error }}
    </div>
    {% endif %}

    <!-- LOAN IDENTIFIERS -->
    <div class="card">
        <h4>Loan Identification</h4>
        <div class="grid-2">
            <div>
                <input type="text" name="lot_number" value="{{ loan_data.lot_number|default:'' }}"
                    placeholder="Lot Number *" required>
                <small style="color: #6b7280; display: block; margin-top: 4px;">Enter a free lot number (not occupied by
                    an active loan).</small>
            </div>
            <input type="text" placeholder="Loan Number (Auto-generated)" readonly style="background-color: #f3f4f6;">
        </div>
    </div>

    <!-- LOAN CALCULATION -->
    <div class="card">
        <h4>Loan Calculation</h4>

        <div class="grid-3">
            <input type="number" step="0.01" name="interest_rate" value="{{ loan_data.interest_rate|default:'' }}"
                placeholder="Interest Rate (%) *" required>
            <input type="number" step="0.01" name="price_per_gram" id="pricePerGram"
                value="{{ loan_data.price_per_gram|default:'' }}" placeholder="Price per Gram *" required
                onchange="calculateTotal()">
            <input type="number" step="0.001" name="approved_grams" id="approvedGrams"
                value="{{ total_approved_grams }}" placeholder="Approved Grams *" required readonly
                style="background-color: #f3f4f6;">
        </div>

        <div class="grid-2">
            <strong>Total Loan Amount</strong>
            <input type="text" id="totalAmount" placeholder="Auto Calculated" readonly
                style="background-color: #f3f4f6; font-weight: 600;">
        </div>

        <p style="margin-top: 10px; color: #6b7280; font-size: 14px;">
            Approved Grams is automatically calculated from Step 2 items (Total: {{ total_approved_grams }} grams)
        </p>

        <p style="margin-top: 10px; color: #059669; font-size: 14px; font-weight: 500;">
            Bank/Pledge details can be added later via the Loan Edit page
        </p>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
        <a href="{% url 'gold_loan:loan_entry_step2' %}" class="btn-secondary">← Back</a>
        <button type="submit" class="btn-primary">Next →</button>
    </div>
</form>

<script>
    function calculateTotal() {
        const pricePerGram = parseFloat(document.getElementById('pricePerGram').value) || 0;
        const approvedGrams = parseFloat(document.getElementById('approvedGrams').value) || 0;
        const totalAmount = pricePerGram * approvedGrams;

        if (totalAmount > 0) {
            document.getElementById('totalAmount').value = '₹ ' + totalAmount.toFixed(2);
        } else {
            document.getElementById('totalAmount').value = '';
        }
    }

    // Calculate on page load if values exist
    window.addEventListener('DOMContentLoaded', function () {
        calculateTotal();
    });

    document.querySelector("form").onsubmit = function (e) {
        const rate = parseFloat(document.querySelector("[name='interest_rate']").value) || 0;
        const price = parseFloat(document.getElementById('pricePerGram').value) || 0;
        const lot = document.querySelector("[name='lot_number']").value.trim();

        if (!lot) {
            alert("Lot Number is required.");
            e.preventDefault();
            return false;
        }

        if (rate < 0 || price <= 0) {
            alert("Interest rate and Price per gram must be valid positive numbers.");
            e.preventDefault();
            return false;
        }
    };
</script>
{% endblock %}