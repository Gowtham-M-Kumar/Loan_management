{% extends "gold_loan/loan/steps_base.html" %}
{% load static %}

{% block step_title %}Step 3 of 5: Loan Configuration{% endblock %}
{% block step_description %}Define the loan terms, interest rates, and link to a secure lot placement.{% endblock %}

{% block step_content %}
{% with current_step=3 back_url="/loan/entry/step-2/" %}
<form method="post" id="stepForm" class="loan-form">
    {% csrf_token %}
    <input type="hidden" name="approved_grams" value="{{ total_approved_grams }}">

    <!-- LOAN IDENTIFIERS -->
    <div class="card">
        <div class="section-header">
            <h4>Loan Identification</h4>
            <p class="section-helper">Assign a lot number and view the system-generated loan identifier.</p>
        </div>
        <div class="grid-2">
            <div>
                <input type="text" name="lot_number" value="{{ loan_data.lot_number|default:'' }}"
                    placeholder="Lot Number *" required>
            </div>
            <div>
                <input type="text" value="{{ loan_number }}" readonly style="background: #f3f4f6; color: #6b7280;"
                    title="System generated loan ID">
            </div>
        </div>
    </div>

    <!-- LOAN CALCULATION -->
    <div class="card">
        <div class="section-header">
            <h4>Loan Calculation & Interest</h4>
            <p class="section-helper">Based on the gold items from Step 2, set the interest rate and market price per
                gram.</p>
        </div>

        <div class="grid-3">
            <input type="number" step="0.01" name="interest_rate" value="{{ loan_data.interest_rate|default:'' }}"
                placeholder="Interest Rate (%) *" required>
            <input type="number" step="0.01" name="price_per_gram" value="{{ loan_data.price_per_gram|default:'' }}"
                placeholder="Price per gram *" required>

            <!-- READONLY INFO FROM STEP 2 -->
            <div
                style="display: flex; flex-direction: column; justify-content: center; background: #eff6ff; padding: 10px; border-radius: 8px; border: 1px solid #bfdbfe;">
                <span style="font-size: 11px; color: #1e40af; font-weight: 700; text-transform: uppercase;">
                    Total Grams (Approved)
                </span>
                <span id="totalGrams" style="font-size: 18px; font-weight: 800; color: #1e3a8a;">
                    {{ total_approved_grams|floatformat:2 }} g
                </span>
            </div>
        </div>

        <div
            style="margin-top: 24px; padding: 24px; background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 12px; text-align: center;">
            <p style="font-size: 14px; color: #64748b; margin-bottom: 8px; font-weight: 600;">
                Calculated Maximum Loan Amount
            </p>
            <h2 id="totalLoanAmount" style="font-size: 32px; font-weight: 900; color: #0f172a; margin: 0;">
                ₹ 0.00
            </h2>
        </div>
    </div>

    <div class="card">
        <div class="section-header">
            <h4>Additional Notes</h4>
            <p class="section-helper">Any extra information related to this loan agreement.</p>
        </div>
        <textarea name="notes" placeholder="Any additional notes..."
            style="min-height: 100px;">{{ loan_data.notes|default:'' }}</textarea>
    </div>
</form>
{% endwith %}
{% endblock %}

{% block footer_left %}
<a href="{% url 'gold_loan:loan_entry_step2' %}" class="btn-google btn-google-back">← Back</a>
{% endblock %}

{% block scripts %}
<script>
    const currentStep = 3;

    function calculateLoan() {
        const grams = parseFloat("{{ total_approved_grams }}") || 0;
        const pricePerGram = parseFloat(document.querySelector("[name='price_per_gram']").value) || 0;
        const total = grams * pricePerGram;

        document.getElementById("totalLoanAmount").innerText = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
        }).format(total);
    }

    document.querySelector("[name='price_per_gram']").addEventListener("input", calculateLoan);

    // Initial calculation
    window.onload = calculateLoan;

    // Lot Number Vacancy Check
    const lotInput = document.querySelector("[name='lot_number']");
    lotInput.addEventListener("change", async function () {
        const lot = this.value.trim();
        if (!lot) return;

        try {
            const response = await fetch(`{% url "gold_loan:check_lot_vacancy" %}?lot_number=${encodeURIComponent(lot)}`);
            const data = await response.json();

            if (!data.vacant) {
                alert("This lot number is not vacant, enter any other.");
                this.value = ""; // Clear the input
                this.focus();
            }
        } catch (err) {
            console.error("Lot check failed:", err);
        }
    });
</script>
{% endblock %}