{% extends "gold_loan/base.html" %}
{% load static %}

{% block title %}Edit Loan – {{ loan.loan_number }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'gold_loan/css/loan_view.css' %}">

{% endblock %}

{% block content %}

<!-- Header Actions -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div style="display: flex; gap: 12px;">
        <a href="{% url 'gold_loan:loan_view' loan.id %}" class="btn btn-secondary"
            style="background: white; color: #374151; border: 1px solid #d1d5db; padding: 10px 20px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <span>←</span> Back to Loan
        </a>
    </div>
    <div style="text-align: right;">
        <h2 style="margin: 0; font-size: 20px; color: #1e293b; font-weight: 800;">Loan #{{ loan.loan_number }}</h2>
        <p style="margin: 4px 0 0; font-size: 13px; color: #64748b; font-weight: 500;">Customer: {{ customer.name }}
        </p>
    </div>
</div>

<div class="summary-card">
    <div class="summary-header" style="padding: 16px 20px;">
        <h3>Current Pledge</h3>
    </div>

    <div class="view-info-grid">
        <!-- Bank -->
        <div class="view-item" style="grid-column: span 2;">
            <div class="view-label">Target Bank</div>
            <div class="view-value display-bank-name" style="font-size: 16px; color: #1e293b;">
                {% if pledge.bank_name %}
                {{ pledge.bank_name }}
                {% else %}
                Not set
                {% endif %}
            </div>

            <div class="view-value display-bank-address"
                style="font-size: 12px; color: #64748b; font-weight: 400; margin-top: 2px;">
                {% if pledge.bank_address %}
                {{ pledge.bank_address }}
                {% else %}
                -
                {% endif %}
            </div>
        </div>

        <!-- Receipt No -->
        <div class="view-item">
            <div class="view-label">Receipt No</div>
            <div class="view-value display-receipt-no">
                {% if pledge.pledge_receipt_no %}
                {{ pledge.pledge_receipt_no }}
                {% else %}
                -
                {% endif %}
            </div>
        </div>

        <!-- Interest Period -->
        <div class="view-item">
            <div class="view-label">Period</div>
            <div class="view-value display-interest-period">
                {% if pledge.interest_period %}
                {{ pledge.interest_period }}
                {% else %}
                -
                {% endif %}
            </div>
        </div>

        <!-- Actual Weight -->
        <div class="view-item">
            <div class="view-label">Actual Weight</div>
            <div class="view-value high display-actual-weight">
                {% if pledge.total_actual_grams %}
                {{ pledge.total_actual_grams|floatformat:3 }}g
                {% else %}
                0.000g
                {% endif %}
            </div>
        </div>

        <!-- Approved Weight -->
        <div class="view-item">
            <div class="view-label">Approved Weight</div>
            <div class="view-value high display-approved-weight">
                {% if pledge.total_approved_grams %}
                {{ pledge.total_approved_grams|floatformat:3 }}g
                {% else %}
                0.000g
                {% endif %}
            </div>
        </div>

        <!-- Price per gram -->
        <div class="view-item">
            <div class="view-label">Price / Gram</div>
            <div class="view-value display-pledge-price">
                {% if pledge.price_per_gram %}
                ₹ {{ pledge.price_per_gram|floatformat:2 }}
                {% else %}
                ₹ 0.00
                {% endif %}
            </div>
        </div>

        <!-- Interest Rate -->
        <div class="view-item">
            <div class="view-label">Rate</div>
            <div class="view-value display-pledge-rate">
                {% if pledge.interest_rate %}
                {{ pledge.interest_rate|floatformat:2 }}%
                {% else %}
                0.00%
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Adjustments -->
    <div class="view-table">
        <div class="view-label" style="margin-bottom: 10px;">Recent Adjustments</div>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Mode</th>
                </tr>
            </thead>
            <tbody>
                {% for adj in adjustments|slice:":5" %}
                <tr>
                    <td>{{ adj.date|date:"d M" }}</td>
                    <td style="font-weight: 700; color: #059669;">
                        ₹ {{ adj.amount|floatformat:2 }}
                    </td>
                    <td>{{ adj.medium }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align:center; padding: 20px; color: #94a3b8;">
                        No adjustments
                    </td>
                </tr>
                {% endfor %}
            </tbody>

            {% if adjustments %}
            <tfoot>
                <tr style="background:#f1f5f9;">
                    <td colspan="3" style="text-align:right; padding:10px; font-weight:800;">
                        Total: ₹ {{ total_adjustment_amount|floatformat:2 }}
                    </td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>


</div>




<div class="edit-container">

    {% if success %}
    <div
        style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 14px 20px; border-radius: 10px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <span style="font-weight: 600;">{{ success }}</span>
        <a href="{% url 'gold_loan:loan_view' loan.id %}"
            style="font-weight: 700; color: #166534; text-decoration: underline;">View Loan Details →</a>
    </div>
    {% endif %}

    {% if error %}
    <div
        style="background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 14px 20px; border-radius: 10px; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <span style="font-weight: 600;">Error:</span> {{ error }}
    </div>
    {% endif %}



    <div class="split-layout">
        <!-- LEFT COLUMN: EDIT FORM -->
        <div class="edit-side">
            <form method="post" id="editForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_loan">

                <div class="section-card" style="padding: 16px 20px;">
                    <h3 style="margin-bottom: 20px;">Edit Company Pledge Details</h3>

                    <div class="field-grid-2">
                        <div class="field-group">
                            <label class="required">Bank Name</label>
                            <input type="text" name="bank_name" id="id_bank_name" value="{{ pledge.bank_name }}"
                                placeholder="Enter receiving bank name" required>
                        </div>
                        <div class="field-group">
                            <label class="required">Pledge Receipt No</label>
                            <input type="text" name="pledge_receipt_no" id="id_receipt_no"
                                value="{{ pledge.pledge_receipt_no }}" placeholder="RE-123456" required>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="required">Bank Address</label>
                        <textarea name="bank_address" id="id_bank_address" rows="2"
                            placeholder="Complete branch address" required>{{ pledge.bank_address }}</textarea>
                    </div>

                    <div class="field-grid-2">
                        <div class="field-group">
                            <label>Interest Period</label>
                            <input type="text" name="interest_period" id="id_interest_period"
                                value="{{ pledge.interest_period|default:'' }}" placeholder="e.g. 10 month">
                        </div>
                        <div class="field-group">
                            <label>Internal Interest Rate (%)</label>
                            <input type="number" step="0.01" name="pledge_interest_rate" id="id_pledge_rate"
                                value="{% if pledge.interest_rate %}{{ pledge.interest_rate|stringformat:'.2f' }}{% endif %}"
                                placeholder="9.00">
                        </div>
                    </div>

                    <div class="field-grid-3">
                        <div class="field-group">
                            <label>Total Actual Grams</label>
                            <input type="number" step="0.001" name="total_actual_grams" id="id_actual_weight"
                                value="{% if pledge.total_actual_grams %}{{ pledge.total_actual_grams|stringformat:'.3f' }}{% endif %}"
                                placeholder="12.000">
                        </div>
                        <div class="field-group">
                            <label>Total Approved Grams</label>
                            <input type="number" step="0.001" name="total_approved_grams" id="id_approved_weight"
                                value="{% if pledge.total_approved_grams %}{{ pledge.total_approved_grams|stringformat:'.3f' }}{% endif %}"
                                placeholder="12.000">
                        </div>
                        <div class="field-group">
                            <label>Price / Gram (₹)</label>
                            <input type="number" step="0.01" name="pledge_price_per_gram" id="id_pledge_price"
                                value="{% if pledge.price_per_gram %}{{ pledge.price_per_gram|stringformat:'.2f' }}{% endif %}"
                                placeholder="10000.00">
                        </div>
                    </div>

                    <!-- <div class="field-group">
                        <label>Internal Notes</label>
                        <input type="text" name="pledge_notes" id="id_pledge_notes"
                            value="{{ pledge.notes|default:'' }}" placeholder="Confidential notes">
                    </div> -->
                </div>

                <div class="data-card" style="margin-top: 30px;">
                    <div class="data-header">
                        <h4>Gold Items Pieces Tracking</h4>
                    </div>
                    <div class="section-body" style="padding: 0;">
                        <table class="finance-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Weight</th>
                                    <th style="width: 100px;">Pieces</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>
                                        <input type="hidden" name="item_id[]" value="{{ item.id }}">
                                        <div style="font-weight: 600;">{{ item.item_name }}</div>
                                        <div style="font-size: 11px; color: #64748b;">{{ item.get_carat_display }}
                                        </div>
                                    </td>
                                    <td class="amount-cell">{{ item.approved_net_weight }}g</td>
                                    <td>
                                        <input type="number" name="item_count[]"
                                            value="{{ item.bundle.item_count|default:1 }}" min="1" required
                                            style="width: 80px; height: 32px; border-radius: 6px; border: 1px solid var(--border-color); padding: 0 8px;">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="data-card" style="margin-top: 30px;">
                    <div class="data-header">
                        <h4>Profit / Adjustment Tracking</h4>
                    </div>
                    <div class="section-body" style="padding: 0;">
                        <table class="finance-table" id="adjTable">
                            <thead>
                                <tr>
                                    <th style="width: 140px;">Date</th>
                                    <th style="width: 140px;">Amount</th>
                                    <th style="width: 150px;">Medium</th>
                                    <th>Notes</th>
                                    <th style="width: 40px;"></th>
                                </tr>
                            </thead>
                            <tbody id="adjBody">
                                {% for adj in adjustments %}
                                <tr>
                                    <td><input type="date" name="adj_date[]" value="{{ adj.date|date:'Y-m-d' }}"
                                            class="f-control-sm"></td>
                                    <td><input type="number" step="0.01" name="adj_amount[]"
                                            class="adj-amount f-control-sm" value="{{ adj.amount }}"
                                            oninput="calculateAdjTotal()" placeholder="0.00">
                                    </td>
                                    <td>
                                        <select name="adj_medium[]" class="f-control-sm"
                                            style="border: 1px solid #cbd5e1; border-radius: 6px; padding: 4px 8px; width: 100%;">
                                            <option value="Cash" {% if adj.medium == 'Cash' %}selected{% endif %}>Cash
                                            </option>
                                            <option value="UPI" {% if adj.medium == 'UPI' %}selected{% endif %}>UPI
                                            </option>
                                            <option value="Bank Transfer"
                                                {% if adj.medium == 'Bank Transfer' %}selected{% endif %}>
                                                Bank Transfer
                                            </option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="adj_notes[]" value="{{ adj.notes|default:'' }}"
                                            class="f-control-sm" placeholder="Details"></td>
                                    <td><button type="button" class="btn-remove-row"
                                            onclick="removeRow(this)">✕</button></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <button type="button" class="btn-add-row" onclick="addRow()">
                    <span>Add Row</span>
                </button>

                <div class="total-section">
                    <span class="total-label">Current Adjustment Total:</span>
                    <span class="total-value" id="grandTotal">₹ {{ total_adjustment_amount|stringformat:'.2f'
                        }}</span>
                </div>
        </div>
    </div>
    </form>
</div>

<!-- RIGHT COLUMN: CURRENT PLEDGE VIEW -->
<div class="view-side">
    <div style="margin-bottom: 24px;">
        <button type="submit" form="editForm" class="btn btn-primary"
            style="width: 100%; padding: 14px; border-radius: 8px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); display: flex; align-items: center; justify-content: center; gap: 10px;">
            Save Changes
        </button>
    </div>


</div>


<script>
    function addRow() {
        const tbody = document.getElementById('adjBody');
        const today = new Date().toISOString().split('T')[0];
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="date" name="adj_date[]" value="${today}"></td>
            <td><input type="number" step="0.01" name="adj_amount[]" class="adj-amount" placeholder="0.00" oninput="calculateAdjTotal()"></td>
            <td>
                <select name="adj_medium[]" class="f-control-sm" style="border: 1px solid #cbd5e1; border-radius: 6px; padding: 4px 8px; width: 100%;">
                    <option value="Cash">Cash</option>
                    <option value="UPI">UPI</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                </select>
            </td>
            <td><input type="text" name="adj_notes[]" placeholder="Details"></td>
            <td style="text-align: center;">
                <button type="button" class="btn-remove-row" onclick="removeRow(this)">✕</button>
            </td>
        `;
        tbody.appendChild(row);
        calculateAdjTotal();
    }

    function removeRow(btn) {
        const row = btn.closest('tr');
        row.remove();
        calculateAdjTotal();
    }

    function calculateAdjTotal() {
        let total = 0;
        const amounts = document.querySelectorAll('.adj-amount');
        amounts.forEach(input => {
            const val = parseFloat(input.value) || 0;
            total += val;
        });
        document.getElementById('grandTotal').innerText = '₹ ' + total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Mirroring functionality
    function initMirroring() {
        const syncMap = [
            { from: '#id_bank_name', to: '.display-bank-name', suffix: '', default: '-' },
            { from: '#id_bank_address', to: '.display-bank-address', suffix: '', default: '' },
            { from: '#id_receipt_no', to: '.display-receipt-no', suffix: '', default: '-' },
            { from: '#id_interest_period', to: '.display-interest-period', suffix: '', default: '-' },
            { from: '#id_actual_weight', to: '.display-actual-weight', suffix: 'g', default: '0.000' },
            { from: '#id_approved_weight', to: '.display-approved-weight', suffix: 'g', default: '0.000' },
            { from: '#id_pledge_price', to: '.display-pledge-price', prefix: '₹ ', default: '0.00' },
            { from: '#id_pledge_rate', to: '.display-pledge-rate', suffix: '%', default: '0.00' },
            { from: '#id_pledge_notes', to: '.display-pledge-notes', suffix: '', default: 'No internal notes.' }
        ];

        syncMap.forEach(item => {
            const input = document.querySelector(item.from);
            const display = document.querySelector(item.to);
            if (input && display) {
                input.addEventListener('input', e => {
                    let val = e.target.value.trim();
                    if (!val) {
                        display.innerText = item.default;
                    } else {
                        display.innerText = (item.prefix || '') + val + (item.suffix || '');
                    }
                });
            }
        });
    }

    function initStickyObserver() {
        const side = document.querySelector('.view-side');
        if (!side) return;

        const observer = new IntersectionObserver(
            ([e]) => side.classList.toggle('stuck', e.intersectionRatio < 1),
            { threshold: [1], rootMargin: '-81px 0px 0px 0px' }
        );

        observer.observe(side);
    }


    window.onload = function () {
        const rows = document.querySelectorAll('#adjBody tr');
        if (rows.length === 0) {
            addRow();
        }
        calculateAdjTotal();
        initMirroring();
        initStickyObserver();
    };
</script>
{% endblock %}