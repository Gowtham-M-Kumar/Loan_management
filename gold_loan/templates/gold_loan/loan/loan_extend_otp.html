{% extends "gold_loan/base.html" %}
{% load static %}

{% block title %}Verify Extension OTP - {{ loan.loan_number }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'gold_loan/css/loan_close.css' %}">
{% endblock %}

{% block content %}
<div class="close-container">
    <div class="close-header">
        <h2 style="margin: 0; color: #111;">Verify OTP for Extension</h2>
        <div style="color: #666; margin-top: 5px;">Loan: {{ loan.loan_number }}</div>
    </div>

    <div style="margin: 20px 0; color: #4b5563;">
        <p style="color: #666; margin-bottom: 20px;">
            An OTP has been sent to the Admin to authorize this extension.
            <br>
            Please enter it below to verify.
            {% if mobile_masked %}
            <br>
            <small>Sent to: {{ mobile_masked }}</small>
            {% endif %}
        </p>
    </div>

    {% if error %}
    <div class="warning-box"
        style="margin-bottom: 20px; background-color: #fef2f2; border: 1px solid #fee2e2; color: #991b1b; padding: 10px; border-radius: 6px;">
        {{ error }}
    </div>
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <div style="margin-bottom: 20px;">
            <input type="text" name="otp" placeholder="Enter 6-digit OTP" required
                style="padding: 10px; width: 100%; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; letter-spacing: 2px; text-align: center;">
        </div>

        <button type="submit" class="btn-primary" id="verifyBtn"
            style="width: 100%; padding: 12px; font-size: 16px; background-color: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Verify & Start Extension
        </button>
    </form>

    <script>
        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();
            const form = this;
            const btn = document.getElementById('verifyBtn');
            const formData = new FormData(form);

            btn.disabled = true;
            btn.innerText = 'Verifying...';

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else {
                        const errorDiv = document.querySelector('.warning-box') || document.createElement('div');
                        if (!document.querySelector('.warning-box')) {
                            errorDiv.className = 'warning-box';
                            errorDiv.style.marginBottom = '20px';
                            errorDiv.style.backgroundColor = '#fef2f2';
                            errorDiv.style.border = '1px solid #fee2e2';
                            errorDiv.style.color = '#991b1b';
                            errorDiv.style.padding = '10px';
                            errorDiv.style.borderRadius = '6px';
                            form.parentElement.insertBefore(errorDiv, form);
                        }
                        errorDiv.innerText = data.error || 'Invalid OTP';
                        errorDiv.style.display = 'block';
                        btn.disabled = false;
                        btn.innerText = 'Verify & Start Extension';
                    }
                })
                .catch(err => {
                    alert('Error verifying OTP');
                    btn.disabled = false;
                    btn.innerText = 'Verify & Start Extension';
                });
        });
    </script>

    <div style="margin-top: 24px; border-top: 1px solid #f1f5f9; padding-top: 16px;">
        <a href="{% url 'gold_loan:loan_view' loan.id %}" class="btn-cancel"
            style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin: 0; background: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; font-weight: 700; text-decoration: none; padding: 12px 20px; border-radius: 12px; transition: all 0.2s;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Loan View
        </a>
    </div>

</div>
{% endblock %}