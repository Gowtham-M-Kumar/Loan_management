{% extends "gold_loan/loan/steps_base.html" %}
{% load static %}

{% block step_title %}Step 5 of 5: Identity Verification{% endblock %}
{% block step_description %}Please enter the 6-digit OTP sent to the registered mobile number to finalize the
application.{% endblock %}

{% block step_content %}
{% with current_step=5 back_url="/loan/entry/step-4/" %}
<div class="otp-box">
    {% if error %}
    <div class="alert alert-error" style="margin-bottom: 20px;">
        {{ error }}
    </div>
    {% endif %}

    <form method="post" class="loan-form" id="stepForm">
        {% csrf_token %}
        <input type="text" name="otp" id="otpInput" maxlength="6" placeholder="Enter 6-digit OTP" required>

        <div style="margin-top: 20px;">
            <p style="color: #5f6368; font-size: 14px;">Didn't receive the code?</p>
            <button type="button" class="btn-google btn-google-back" id="resendOtp" style="border: none;">
                Resend OTP
            </button>
        </div>
    </form>
</div>
{% endwith %}
{% endblock %}

{% block footer_left %}
<a href="{% url 'gold_loan:loan_entry_step4' %}" class="btn-google btn-google-back">‚Üê Back</a>
{% endblock %}

{% block scripts %}
<script>
    const currentStep = 5;

    document.getElementById('resendOtp').addEventListener('click', function () {
        const btn = this;
        btn.disabled = true;
        btn.innerText = 'Resending...';

        fetch("{% url 'gold_loan:resend_otp_api' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('OTP has been resent successfully.');
                } else {
                    alert('Error resending OTP: ' + (data.error || 'Unknown error'));
                }
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = 'Resend OTP';
            });
    });

    // Cleanup sessionStorage upon successful form submission
    document.getElementById('stepForm').addEventListener('submit', function () {
        sessionStorage.removeItem("customer_photo_preview");
    });
</script>
{% endblock %}