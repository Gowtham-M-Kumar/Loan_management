{% extends "gold_loan/base.html" %}
{% load static %}

{% block title %}Payment - {{ loan.loan_number }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'gold_loan/css/payment.css' %}">
{% endblock %}

{% block page_header %}
<div class="view-container">
    <div class="header-actions"
        style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 0;">
        <div>
            <a href="{% url 'gold_loan:loan_view' loan.id %}" class="btn-back-circle"
                style="width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid #e2e8f0; color: #64748b; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"
                title="Back to Loan View">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </a>
        </div>
        <a href="{% url 'gold_loan:payment_summary_receipt' loan.id %}" target="_blank" class="btn btn-secondary"
            style="color: #2563eb; border-color: #bfdbfe; background: #eff6ff;">
            Full Summary Receipt
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="view-container">

    {% if error %}
    <div class="alert-error">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="payment-layout">

        <!-- ðŸŸ¦ SECTION 1: Summaries -->
        <div class="section-card">
            <div class="section-header">
                <h4 class="section-title">Loan & Financial Overview</h4>
                <span class="status-badge status-{{ loan.status|lower }}">{{ loan.get_status_display }}</span>
            </div>
            <div class="section-body">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Customer</div>
                        <div class="info-value">{{ loan.customer.name }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Loan ID</div>
                        <div class="info-value">{{ loan.loan_number }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Outstanding Principal</div>
                        <div class="info-value-danger">â‚¹{{ outstanding_principal|floatformat:2 }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Accrued Interest</div>
                        <div class="info-value-warn">â‚¹{{ loan.pending_interest }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Original Loan</div>
                        <div class="info-value">â‚¹{{ loan.total_amount }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Principal Paid</div>
                        <div class="info-value-large" style="font-size: 18px;">â‚¹{{ total_paid }}</div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ðŸ§® SECTION 2: History -->
        <div class="section-card">
            <div class="section-header">
                <h4 class="section-title">Payment History</h4>
            </div>
            <div class="section-body" style="padding: 0;">
                <table class="view-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Amount</th>
                            <th>Interest portion</th>
                            <th>Principal portion</th>
                            <th>Method</th>
                            <th>Reference</th>
                            <th>Receipt</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in payments %}
                        <tr>
                            <td style="font-weight: 500;">{{ p.payment_date }}</td>
                            <td style="font-weight: 700;">â‚¹{{ p.total_amount }}</td>
                            <td style="color: #d97706;">â‚¹{{ p.interest_component }}</td>
                            <td style="color: #059669;">â‚¹{{ p.principal_component }}</td>
                            <td><span style="font-size: 11px; font-weight: 600; text-transform: uppercase;">{{
                                    p.payment_mode }}</span></td>
                            <td style="font-size: 13px; color: #64748b;">{{ p.reference_no|default:"-" }}</td>
                            <td>
                                <a href="{% url 'gold_loan:payment_receipt' p.id %}" target="_blank"
                                    class="btn btn-secondary"
                                    style="padding: 4px 12px; font-size: 12px; border-radius: 6px;">
                                    Print
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" style="text-align:center; padding: 40px; color: #94a3b8;">
                                No payments found for this loan.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ðŸ“Œ FIXED ACTION FOOTER: RECORD PAYMENT -->
    <div class="view-action-footer">
        <div class="footer-form-container" style="display: flex; width: 100%; align-items: center; gap: 20px;">
            <div class="footer-left-actions">
                <!-- Back button moved to header -->
            </div>

            {% if loan.status == 'active' %}
            <form method="POST" class="footer-form" style="flex: 1; display: flex; align-items: center; gap: 20px;">
                {% csrf_token %}

                <div class="footer-info-block" style="min-width: 140px;">
                    <h2
                        style="color: var(--primary); font-weight: 900; margin: 0; line-height: 1; letter-spacing: -0.02em;">
                        PAYMENT</h2>
                    <p
                        style="font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-top: 4px;">
                        Receivable: â‚¹{{ total_due|floatformat:2 }}
                    </p>
                </div>

                <div class="footer-fields" style="flex: 1; display: flex; gap: 16px; align-items: flex-end;">
                    <div class="f-input-group" style="flex: 1;">
                        <label>Amount (â‚¹)</label>
                        <input type="number" name="amount" class="f-control"
                            style="font-weight: 700; color: var(--primary);" min="1" step="0.01" placeholder="0.00"
                            required>
                    </div>

                    <div class="f-input-group" style="flex: 1;">
                        <label>Mode</label>
                        <select name="payment_mode" class="f-control" required>
                            <option value="cash">Cash</option>
                            <option value="upi">UPI</option>
                            <option value="bank">Bank</option>
                        </select>
                    </div>

                    <div class="f-input-group" style="flex: 1;">
                        <label>Payment Date</label>
                        <input type="date" name="payment_date" class="f-control" value="{{ today_date }}" required>
                    </div>

                    <button type="submit" class="btn-record" style="height: 48px; min-width: 180px;">Confirm Payment
                        â†’</button>
                </div>
            </form>
            {% else %}
            <div class="footer-form" style="flex: 1; justify-content: center; opacity: 0.6;">
                <p style="font-weight: 600; color: var(--text-secondary);">
                    ðŸ”’ Payment collection is locked for this {{ loan.get_status_display }} loan.
                </p>
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    async function runSimulation() {
        const daysInput = document.getElementById('simulate-days');
        const days = daysInput.value;
        const btn = document.getElementById('sim-btn');
        const resultsDiv = document.getElementById('sim-results');

        if (!days || days < 0) {
            alert("Please enter a valid number of days.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Calcul...";

        try {
            const response = await fetch(`{% url 'gold_loan:simulate_interest' loan.id %}?days=${days}`);
            const data = await response.json();

            if (response.ok) {
                resultsDiv.style.display = 'block';
                document.getElementById('res-date').innerText = data.simulated_date;
                document.getElementById('res-int-days').innerText = Math.max(0, data.days - 10) + " Days";
                document.getElementById('res-interest').innerText = "â‚¹" + data.simulated_interest.toLocaleString(undefined, { minimumFractionDigits: 2 });
                document.getElementById('res-caps').innerText = data.capitalizations_count;
                document.getElementById('res-total').innerText = "â‚¹" + data.total_payable.toLocaleString(undefined, { minimumFractionDigits: 2 });
            } else {
                alert("Error: " + (data.error || "Failed to simulate"));
            }
        } catch (err) {
            console.error(err);
            alert("An error occurred during simulation.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Simulate";
        }
    }
</script>
{% endblock %}